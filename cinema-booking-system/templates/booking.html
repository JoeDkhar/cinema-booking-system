{{template "base.html" .}}

{{define "title"}}Book Tickets for {{.Show.Movie.Title}}{{end}}

{{define "content"}}
<section class="booking-section">
    <h1>Select Seats</h1>
    <div class="booking-details">
        <h2>{{.Show.Movie.Title}}</h2>
        <p><strong>Date:</strong> {{formatDate .Show.DateTime}}</p>
        <p><strong>Time:</strong> {{formatTime .Show.DateTime}}</p>
        <p><strong>Hall:</strong> {{.Show.HallNumber}}</p>
        <p><strong>Price per Ticket:</strong> {{formatCurrency .Show.TicketPrice}}</p>
    </div>

    <div class="seat-selection-container">
        <div class="screen">SCREEN</div>
        
        <div class="seating-layout" id="seatingLayout">
            <!-- Seating layout will be generated by JavaScript -->
        </div>
        
        <div class="seat-legend">
            <div class="seat-type">
                <div class="seat available"></div>
                <span>Available</span>
            </div>
            <div class="seat-type">
                <div class="seat selected"></div>
                <span>Selected</span>
            </div>
            <div class="seat-type">
                <div class="seat booked"></div>
                <span>Booked</span>
            </div>
        </div>
    </div>

    <div class="booking-summary">
        <h2>Booking Summary</h2>
        <div id="selectedSeatsDisplay">No seats selected</div>
        <div id="totalPrice">Total: {{formatCurrency 0}}</div>
        
        <form id="bookingForm" action="/booking" method="POST">
            <input type="hidden" name="show_id" value="{{.Show.ID}}">
            <input type="hidden" name="seats" id="seatsInput">
            
            <div class="form-group">
                <label for="customer_name">Your Name:</label>
                <input type="text" id="customer_name" name="customer_name" required>
            </div>
            
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>
            
            <button type="submit" class="btn btn-primary" id="submitBooking" disabled>Complete Booking</button>
        </form>
    </div>
</section>
{{end}}

{{define "scripts"}}
<script>
    // Store the show data for JavaScript access
    const showData = {
        id: {{.Show.ID}},
        ticketPrice: {{.Show.TicketPrice}},
        totalSeats: {{.Show.TotalSeats}}
    };
    
    // Predefined map of booked seats
    const bookedSeats = {};
    {{range $key, $value := .BookedSeats}}
    bookedSeats["{{$key}}"] = {{$value}};
    {{end}}
    
    // Initialize the seating layout when document is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeSeatingLayout();
    });
    
    // Initialize the seating layout
    function initializeSeatingLayout() {
        const seatingLayout = document.getElementById('seatingLayout');
        if (!seatingLayout) return;
        
        // Determine rows and seats per row based on total seats
        const rows = calculateRows(showData.totalSeats);
        const seatsPerRow = Math.ceil(showData.totalSeats / rows.length);
        
        // Store the selected seats
        const selectedSeats = [];
        
        // Create the seating layout
        rows.forEach(row => {
            const seatRow = document.createElement('div');
            seatRow.className = 'seat-row';
            
            // Add row label
            const rowLabel = document.createElement('div');
            rowLabel.className = 'row-label';
            rowLabel.textContent = row;
            seatRow.appendChild(rowLabel);
            
            // Add seats in this row
            for (let i = 1; i <= seatsPerRow; i++) {
                if ((rows.indexOf(row) * seatsPerRow + i) > showData.totalSeats) {
                    break; // Stop when we've created all the seats
                }
                
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.dataset.row = row;
                seat.dataset.number = i;
                seat.textContent = i;
                
                // Check if the seat is already booked
                const seatKey = row + i;
                if (bookedSeats[seatKey]) {
                    seat.className += ' booked';
                } else {
                    seat.className += ' available';
                    
                    // Add click event for available seats
                    seat.addEventListener('click', function() {
                        if (this.classList.contains('selected')) {
                            // Deselect seat
                            this.classList.remove('selected');
                            this.classList.add('available');
                            
                            // Remove from selected seats
                            const index = selectedSeats.findIndex(s => 
                                s.row === this.dataset.row && s.number === parseInt(this.dataset.number)
                            );
                            if (index !== -1) {
                                selectedSeats.splice(index, 1);
                            }
                        } else {
                            // Select seat
                            this.classList.remove('available');
                            this.classList.add('selected');
                            
                            // Add to selected seats
                            selectedSeats.push({
                                row: this.dataset.row,
                                number: parseInt(this.dataset.number)
                            });
                        }
                        
                        updateBookingSummary(selectedSeats);
                    });
                }
                
                seatRow.appendChild(seat);
            }
            
            seatingLayout.appendChild(seatRow);
        });
    }

    // Calculate appropriate rows based on total seats
    function calculateRows(totalSeats) {
        const baseRows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
        const extraRows = ['I', 'J', 'K', 'L', 'M', 'N', 'O', 'P'];
        
        if (totalSeats <= 60) {
            return baseRows.slice(0, 5); // 5 rows for small halls
        } else if (totalSeats <= 90) {
            return baseRows.slice(0, 6); // 6 rows for medium halls
        } else if (totalSeats <= 120) {
            return baseRows; // 8 rows for standard halls
        } else {
            // For larger halls, add more rows as needed
            const additionalRows = Math.ceil((totalSeats - 120) / 16);
            return baseRows.concat(extraRows.slice(0, additionalRows));
        }
    }
    
    // Update the booking summary when seats are selected
    function updateBookingSummary(selectedSeats) {
        const selectedSeatsDisplay = document.getElementById('selectedSeatsDisplay');
        const totalPriceDisplay = document.getElementById('totalPrice');
        const seatsInput = document.getElementById('seatsInput');
        const submitButton = document.getElementById('submitBooking');
        
        if (selectedSeats.length === 0) {
            selectedSeatsDisplay.textContent = 'No seats selected';
            totalPriceDisplay.textContent = 'Total: $0.00';
            submitButton.disabled = true;
        } else {
            // Format the selected seats for display
            const seatText = selectedSeats
                .map(seat => `${seat.row}${seat.number}`)
                .sort()
                .join(', ');
                
            selectedSeatsDisplay.textContent = `Selected seats: ${seatText}`;
            
            // Calculate and display total price
            const totalPrice = (selectedSeats.length * showData.ticketPrice).toFixed(2);
            totalPriceDisplay.textContent = `Total: $${totalPrice}`;
            
            // Update hidden input with JSON data of selected seats
            seatsInput.value = JSON.stringify(selectedSeats);
            
            // Enable submit button
            submitButton.disabled = false;
        }
    }
    
    // Validate form before submission
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        const customerName = document.getElementById('customer_name').value.trim();
        const email = document.getElementById('email').value.trim();
        const seatsInput = document.getElementById('seatsInput').value;
        
        if (!customerName || !email || !seatsInput || seatsInput === '[]') {
            e.preventDefault();
            alert('Please fill in all required fields and select at least one seat.');
            return;
        }
        
        // Simple email validation
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(email)) {
            e.preventDefault();
            alert('Please enter a valid email address.');
            return;
        }
    });
</script>
{{end}}